<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プレゼンタイマー</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF7669' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><polyline points='12 6 12 12 16 14'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF7669' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><polyline points='12 6 12 12 16 14'/></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #root {
            width: 100%;
            height: 100vh;
        }

        /* スライダーのスタイル */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: #e5e5e5;
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #ec4899;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -4px;
        }

        input[type="range"]::-moz-range-track {
            background: #e5e5e5;
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-moz-range-thumb {
            background: #ec4899;
            border: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // アイコンコンポーネント
        const PlayIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );

        const PauseIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        );

        const RotateCcwIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
        );

        const BellIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        );

        const PlusIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const SettingsIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const Volume2Icon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        );

        const PresentationTimer = () => {
            // 基本状態
            const [isRunning, setIsRunning] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [limitTime, setLimitTime] = useState(10);
            const [passedTime, setPassedTime] = useState(0);
            const [bellSettings, setBellSettings] = useState([
                { id: 1, minutes: 5, enabled: true, isFixed: false, ringCount: 1 }
            ]);
            const [bellTriggered, setBellTriggered] = useState(new Set());
            
            // UX状態
            const [showSettings, setShowSettings] = useState(false);
            const [isFirstTime, setIsFirstTime] = useState(true);
            const [showQuickActions, setShowQuickActions] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            
            // 音量設定
            const [bellVolume, setBellVolume] = useState(0.8);
            const [showVolumeSlider, setShowVolumeSlider] = useState(false);
            const volumeSliderTimeoutRef = useRef(null);
            
            // テストモード
            const [isTestMode, setIsTestMode] = useState(false);

            // 参照
            const intervalRef = useRef(null);
            const startTimeRef = useRef(0);
            const pausedTimeRef = useRef(0);
            const bellAudioRef = useRef(null);

            // キーボードショートカット
            useEffect(() => {
                const handleKeyPress = (e) => {
                    // スペースキー: 開始/停止
                    if (e.code === 'Space' && !showSettings && !showResetConfirm) {
                        e.preventDefault();
                        if (!isRunning) {
                            startTimer();
                        } else if (!isPaused) {
                            pauseTimer();
                        } else {
                            startTimer(); // 再開
                        }
                    }
                    // Rキー: リセット
                    if (e.code === 'KeyR' && !showSettings && !showResetConfirm) {
                        e.preventDefault();
                        if (isRunning || passedTime > 0) {
                            setShowResetConfirm(true);
                        } else {
                            resetTimer();
                        }
                    }
                    // Bキー: 手動ベル
                    if (e.code === 'KeyB' && !showSettings && !showResetConfirm) {
                        e.preventDefault();
                        playBell(1);
                    }
                    // Escキー: 設定閉じる
                    if (e.code === 'Escape') {
                        e.preventDefault();
                        if (showResetConfirm) {
                            setShowResetConfirm(false);
                        } else if (showSettings) {
                            setShowSettings(false);
                        }
                    }
                };

                document.addEventListener('keydown', handleKeyPress);
                return () => document.removeEventListener('keydown', handleKeyPress);
            }, [isRunning, isPaused, showSettings, showResetConfirm, passedTime]);

            // 音声初期化
            useEffect(() => {
                const initAudio = () => {
                    if (!bellAudioRef.current) {
                        try {
                            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            bellAudioRef.current = audioContext;
                        } catch (error) {
                            console.error('Audio context initialization failed:', error);
                        }
                    }
                };
                
                const handleFirstInteraction = () => {
                    initAudio();
                    if (bellAudioRef.current && bellAudioRef.current.state === 'suspended') {
                        bellAudioRef.current.resume();
                    }
                    document.removeEventListener('click', handleFirstInteraction);
                };
                
                document.addEventListener('click', handleFirstInteraction);
                
                return () => {
                    document.removeEventListener('click', handleFirstInteraction);
                    if (bellAudioRef.current && bellAudioRef.current.state !== 'closed') {
                        bellAudioRef.current.close();
                    }
                };
            }, []);

            // 発表時間変更時の自動調整
            useEffect(() => {
                setBellSettings(prev => {
                    const updatedNormalBells = prev.filter(bell => !bell.isFixed).map(bell => {
                        if (bell.minutes >= limitTime) {
                            const adjustedMinutes = Math.max(1, limitTime - 1);
                            return { ...bell, minutes: adjustedMinutes };
                        }
                        return bell;
                    });

                    const fixedBell = {
                        id: 'fixed',
                        minutes: limitTime,
                        enabled: true,
                        isFixed: true,
                        ringCount: 3
                    };

                    return [...updatedNormalBells, fixedBell];
                });
            }, [limitTime]);

            // 高品質ベル音再生
            const playBell = useCallback((bellNumber = 1, isEndBell = false, isStartBell = false) => {
                console.log('Bell play triggered:', { bellNumber, isEndBell, isStartBell, audioContext: bellAudioRef.current });
                
                if (!bellAudioRef.current) {
                    console.error('Audio context not initialized');
                    return;
                }
                
                // Audio contextが停止している場合は再開
                if (bellAudioRef.current.state === 'suspended') {
                    bellAudioRef.current.resume().then(() => {
                        console.log('Audio context resumed');
                        startBellSequence();
                    });
                } else if (bellAudioRef.current.state === 'running') {
                    startBellSequence();
                } else {
                    console.error('Audio context state:', bellAudioRef.current.state);
                }

                function startBellSequence() {
                    // ベル回数の決定
                    let ringCount = 1;
                    if (isStartBell) {
                        ringCount = 1; // スタートベルは1回のみ
                    } else if (isEndBell) {
                        // 終了ベルの場合、bellNumberが回数を示す
                        ringCount = bellNumber;
                    } else if (bellNumber && typeof bellNumber === 'number') {
                        // 通常ベル: ベルの設定から回数を取得
                        const bell = bellSettings.find(b => b.id === bellNumber);
                        ringCount = bell ? bell.ringCount : 1;
                    }
                    
                    console.log('Ring count determined:', ringCount, 'for bell:', bellNumber, 'isEndBell:', isEndBell);
                    
                    // 指定回数分ベルを鳴らす
                    for (let i = 0; i < ringCount; i++) {
                        // 各ベル音を独立して生成（遅延は外側で管理）
                        const delay = i * (isStartBell ? 0 : 600);
                        setTimeout(() => {
                            playBellTone(isStartBell);
                        }, delay);
                    }
                }

                function playBellTone(isStartBell) {
                    try {
                        // マスターゲインノードを作成して全体の音量を管理
                        const masterGain = bellAudioRef.current.createGain();
                        masterGain.connect(bellAudioRef.current.destination);
                        
                        // 現在時刻を取得
                        const now = bellAudioRef.current.currentTime;
                        
                        // マスターゲインを音量設定に基づいて設定
                        masterGain.gain.setValueAtTime(bellVolume, now);
                        
                        if (isStartBell) {
                            // 開始ベル用の明るく前向きな音色（2音の和音）
                            const duration = 0.6;
                            
                            // 明るいメジャー3度の和音（C6 + E6）
                            const baseFreq = 1047; // C6
                            const harmonicFreq = 1319; // E6（長3度上）
                            
                            // 1音目（ベース音）
                            const osc1 = bellAudioRef.current.createOscillator();
                            const gain1 = bellAudioRef.current.createGain();
                            
                            osc1.type = 'sine';
                            osc1.frequency.setValueAtTime(baseFreq, now);
                            
                            gain1.gain.setValueAtTime(0.8, now);
                            gain1.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                            
                            osc1.connect(gain1);
                            gain1.connect(masterGain);
                            
                            // 2音目（ハーモニー音）
                            const osc2 = bellAudioRef.current.createOscillator();
                            const gain2 = bellAudioRef.current.createGain();
                            
                            osc2.type = 'sine';
                            osc2.frequency.setValueAtTime(harmonicFreq, now);
                            
                            gain2.gain.setValueAtTime(0.6, now);
                            gain2.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                            
                            osc2.connect(gain2);
                            gain2.connect(masterGain);
                            
                            // 軽やかなアタック音（短い高音）
                            const attackOsc = bellAudioRef.current.createOscillator();
                            const attackGain = bellAudioRef.current.createGain();
                            
                            attackOsc.type = 'sine';
                            attackOsc.frequency.setValueAtTime(2093, now); // 高い音
                            
                            attackGain.gain.setValueAtTime(0.3, now);
                            attackGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
                            
                            attackOsc.connect(attackGain);
                            attackGain.connect(masterGain);
                            
                            // 再生開始
                            osc1.start(now);
                            osc1.stop(now + duration + 0.1);
                            osc2.start(now);
                            osc2.stop(now + duration + 0.1);
                            attackOsc.start(now);
                            attackOsc.stop(now + 0.15);
                            
                        } else {
                            // 通常ベル（実測データに基づく）
                            const partials = [
                                { freq: 5428, gain: 1.0 },
                                { freq: 1052, gain: 0.6 },
                                { freq: 2928, gain: 0.28 },
                                { freq: 2926, gain: 0.21 },
                                { freq: 2931, gain: 0.14 },
                                { freq: 8486, gain: 0.14 },
                                { freq: 2933, gain: 0.12 },
                                { freq: 1072, gain: 0.10 }
                            ];
                            
                            const duration = 1.5;
                            
                            // 各周波数でオシレーター生成
                            partials.forEach(({ freq, gain }) => {
                                const osc = bellAudioRef.current.createOscillator();
                                const g = bellAudioRef.current.createGain();
                                
                                osc.type = 'sine';
                                osc.frequency.setValueAtTime(freq, now);
                                
                                // ゲイン：時間とともに指数減衰
                                g.gain.setValueAtTime(gain, now);
                                g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                                
                                osc.connect(g);
                                g.connect(masterGain);
                                
                                osc.start(now);
                                osc.stop(now + duration + 0.1);
                            });
                            
                            // アタックノイズバーストの追加（ホワイトノイズ）
                            const noiseBuffer = bellAudioRef.current.createBuffer(1, bellAudioRef.current.sampleRate * 0.03, bellAudioRef.current.sampleRate);
                            const output = noiseBuffer.getChannelData(0);
                            for (let i = 0; i < output.length; i++) {
                                output[i] = Math.random() * 2 - 1;
                            }
                            
                            const noiseSource = bellAudioRef.current.createBufferSource();
                            noiseSource.buffer = noiseBuffer;
                            const noiseGain = bellAudioRef.current.createGain();
                            
                            noiseGain.gain.setValueAtTime(0.3, now);
                            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                            
                            noiseSource.connect(noiseGain);
                            noiseGain.connect(masterGain);
                            
                            noiseSource.start(now);
                            noiseSource.stop(now + 0.06);
                        }
                        
                        console.log('Bell tone played successfully at:', now);
                    } catch (error) {
                        console.error('Error playing bell tone:', error);
                    }
                }
            }, [bellSettings, bellVolume]);

            // タイマー更新
            const updateTimer = useCallback(() => {
                if (!isRunning || isPaused) return;

                const currentTime = Date.now();
                const elapsedTime = currentTime - startTimeRef.current + pausedTimeRef.current;
                
                // テストモードでは20倍速で進行
                const timeMultiplier = isTestMode ? 20 : 1;
                const newPassedTime = Math.floor((elapsedTime * timeMultiplier) / 1000);
                
                // 現在のベル設定を取得（テストモードでも通常のベル設定を使用）
                const currentBellSettings = bellSettings;
                
                currentBellSettings.forEach(bell => {
                    const triggerTime = bell.minutes * 60;
                    if (bell.enabled && newPassedTime >= triggerTime && !bellTriggered.has(bell.id)) {
                        // 終了ベルの場合は通常ベルの数+1回鳴らす
                        if (bell.isFixed) {
                            const fixedBell = bellSettings.find(b => b.isFixed);
                            playBell(fixedBell.ringCount, true);  // isEndBellをtrueに設定
                        } else {
                            playBell(typeof bell.id === 'number' ? bell.id : 1, false);
                        }
                        setBellTriggered(prev => new Set([...prev, bell.id]));
                    }
                });

                setPassedTime(newPassedTime);
            }, [isRunning, isPaused, bellSettings, isTestMode, bellTriggered, playBell]);

            useEffect(() => {
                if (isRunning && !isPaused) {
                    intervalRef.current = setInterval(updateTimer, 100);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                }
                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isRunning, isPaused, updateTimer]);

            // タイマー操作
            const startTimer = () => {
                if (isPaused) {
                    // 再開時は現在時刻を新しい開始時刻として設定
                    startTimeRef.current = Date.now();
                    setIsPaused(false);
                } else {
                    startTimeRef.current = Date.now();
                    pausedTimeRef.current = 0;
                    setBellTriggered(new Set());
                    setIsFirstTime(false);
                    // スタートベルを鳴らす
                    setTimeout(() => playBell(1, false, true), 100);
                }
                setIsRunning(true);
                setShowSettings(false);
            };

            const pauseTimer = () => {
                if (isRunning) {
                    setIsPaused(true);
                    // テストモードを考慮した実際の経過時間を保存
                    const currentTime = Date.now();
                    const realElapsedTime = currentTime - startTimeRef.current;
                    pausedTimeRef.current += realElapsedTime;
                }
            };

            const resetTimer = () => {
                setIsRunning(false);
                setIsPaused(false);
                setPassedTime(0);
                setBellTriggered(new Set());
                pausedTimeRef.current = 0;
                setIsFirstTime(true);
                setShowResetConfirm(false);
            };

            const handleResetClick = () => {
                if (isRunning || passedTime > 0) {
                    setShowResetConfirm(true);
                } else {
                    resetTimer();
                }
            };

            // 音量スライダーの表示制御
            const handleVolumeSliderShow = () => {
                if (volumeSliderTimeoutRef.current) {
                    clearTimeout(volumeSliderTimeoutRef.current);
                }
                setShowVolumeSlider(true);
            };

            const handleVolumeSliderHide = () => {
                volumeSliderTimeoutRef.current = setTimeout(() => {
                    setShowVolumeSlider(false);
                }, 300); // 300ms遅延して消える
            };

            // 時間調整
            const adjustTime = (amount) => {
                setLimitTime(prev => Math.max(1, prev + amount));
            };

            // クイックセット
            const quickSetTime = (minutes) => {
                setLimitTime(minutes);
                setShowQuickActions(false);
            };

            // ベル設定操作
            const updateBellSetting = (bellId, field, value) => {
                setBellSettings(prev => prev.map(bell => 
                    bell.id === bellId ? { ...bell, [field]: value } : bell
                ));
            };

            const addBellSetting = () => {
                // 現在の通常ベルの数を確認
                const normalBells = bellSettings.filter(b => !b.isFixed).sort((a, b) => a.minutes - b.minutes);
                if (normalBells.length >= limitTime - 1) {
                    return; // 最大数に達している場合は追加しない
                }
                
                // 最後の通常ベルの分数を取得
                const lastNormalBell = normalBells[normalBells.length - 1];
                const lastBellMinutes = lastNormalBell ? lastNormalBell.minutes : 0;
                
                // 新しいベルを追加できる余地があるかチェック
                if (lastBellMinutes >= limitTime - 1) {
                    // 最後のベルが既に最大値の場合は追加しない
                    return;
                }
                
                const newId = Math.max(...bellSettings.filter(b => typeof b.id === 'number').map(b => b.id), 0) + 1;
                
                // 新しいベルのデフォルト分数を設定（最後のベル+1分、ただし最大値を超えない）
                const defaultMinutes = Math.min(lastBellMinutes + 1, limitTime - 1);
                
                console.log('Adding new bell:', { lastBellMinutes, defaultMinutes, limitTime });
                
                setBellSettings(prev => {
                    const nonFixed = prev.filter(b => !b.isFixed);
                    const fixed = prev.filter(b => b.isFixed);
                    return [...nonFixed, { id: newId, minutes: defaultMinutes, enabled: true, isFixed: false, ringCount: 1 }, ...fixed];
                });
            };

            const removeBellSetting = (bellId) => {
                setBellSettings(prev => prev.filter(bell => bell.id !== bellId));
            };

            // 計算
            const actualLimitTime = limitTime * 60; // 常に分→秒変換（テストモードでも同じ）
            const remainingTime = actualLimitTime - passedTime;
            const isOvertime = passedTime > actualLimitTime;
            const displayMinutes = Math.floor(Math.abs(remainingTime) / 60);
            const displaySeconds = Math.abs(remainingTime) % 60;
            const progressPercentage = Math.min(100, (passedTime / actualLimitTime) * 100);

            return (
                <div className={`${isRunning ? 'h-screen overflow-hidden' : 'min-h-screen'} bg-gray-50 text-gray-900 flex flex-col`}>
                    {/* ヘッダー - 再生中は非表示 */}
                    {!isRunning && (
                        <header className="px-6 py-4 bg-white border-b border-gray-200 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <h1 className="text-xl font-medium text-gray-900">プレゼンタイマー</h1>
                                {/* テストモード切り替え */}
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center gap-2 text-sm">
                                        <span className={`font-medium transition-colors ${!isTestMode ? 'text-blue-600' : 'text-gray-400'}`}>
                                            本番
                                        </span>
                                        <button
                                            onClick={() => {
                                                if (isRunning) return; // 実行中は切り替え不可
                                                setIsTestMode(!isTestMode);
                                                setBellTriggered(new Set());
                                                setPassedTime(0);
                                            }}
                                            disabled={isRunning}
                                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 ${
                                                isTestMode ? 'bg-orange-600' : 'bg-blue-600'
                                            }`}
                                            title={isTestMode ? '本番モードに切り替える' : 'テストモード（20倍速）でベル音のタイミングを確認する'}
                                        >
                                            <span
                                                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                    isTestMode ? 'translate-x-6' : 'translate-x-1'
                                                }`}
                                            />
                                        </button>
                                        <span className={`font-medium transition-colors ${isTestMode ? 'text-orange-600' : 'text-gray-400'}`}>
                                            テスト
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {!isRunning && (
                                    <button
                                        onClick={() => setShowQuickActions(!showQuickActions)}
                                        className="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors relative"
                                    >
                                        クイック設定
                                        {showQuickActions && (
                                            <div className="absolute top-full right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 p-2 z-10 whitespace-nowrap">
                                                {[5, 10, 15, 20, 30].map(time => (
                                                    <button
                                                        key={time}
                                                        onClick={() => quickSetTime(time)}
                                                        className="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded transition-colors"
                                                    >
                                                        {time}分
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </button>
                                )}
                                <button
                                    onClick={() => setShowSettings(!showSettings)}
                                    className="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
                                    disabled={isRunning && !isPaused}
                                >
                                    <SettingsIcon size={20} />
                                </button>
                            </div>
                        </header>
                    )}

                    {/* メインタイマーエリア */}
                    <main className={`flex-1 flex flex-col ${isRunning ? 'justify-between' : 'items-center justify-center'} px-6 ${isRunning ? 'py-8' : 'py-4'} overflow-auto`}>
                        {/* 時間設定 - 初回時のみ目立つ表示 */}
                        {isFirstTime && !isRunning && (
                            <div className={`${isTestMode ? 'mb-4' : 'mb-8'} text-center`}>
                                <p className="text-sm text-gray-600 mb-4">発表時間を設定してください</p>
                                <div className="flex items-center justify-center gap-4">
                                    <button
                                        onClick={() => adjustTime(-1)}
                                        disabled={limitTime <= 1}
                                        className="w-12 h-12 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center font-medium transition-colors"
                                    >
                                        −
                                    </button>
                                    <div className="px-6 py-3 bg-white rounded-lg border border-gray-300 min-w-[120px] text-center">
                                        <span className="text-4xl font-medium">{limitTime}</span>
                                        <span className="text-lg text-gray-600 ml-1">分</span>
                                    </div>
                                    <button
                                        onClick={() => adjustTime(1)}
                                        className="w-12 h-12 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center font-medium transition-colors"
                                    >
                                        +
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* テストモード表示 */}
                        {isTestMode && (
                            <div className={`text-center ${isRunning ? 'mb-2' : 'mb-4'}`}>
                                <div className="inline-flex items-center gap-2 px-4 py-2 bg-orange-50 border border-orange-200 rounded-lg mb-2">
                                    <div className="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                                    <span className="text-sm font-medium text-orange-800">テストモード（20倍速）</span>
                                </div>
                                {!isRunning && (
                                    <p className="text-sm text-gray-600">
                                        本番と同じ設定で20倍速でテストできます。ベル音のタイミングを確認できます。
                                    </p>
                                )}
                            </div>
                        )}

                        {/* 巨大タイマー表示 */}
                        <div className={`text-center ${isRunning ? 'flex-1 flex flex-col justify-center' : ''} ${!isRunning && isTestMode && isFirstTime ? 'mb-4' : !isRunning ? 'mb-8' : ''}`}>
                            <div className={isRunning ? 'mb-1' : 'mb-4'}>
                                <span className={`text-gray-500 font-bold ${isRunning ? 'text-3xl md:text-4xl' : 'text-5xl'}`}>
                                    {isOvertime ? '超過時間' : '残り時間'}
                                </span>
                            </div>
                            <div className={`font-black leading-none ${isRunning ? 'mb-1' : 'mb-2'} ${isOvertime ? 'text-red-500' : 'text-gray-900'}`}
                                 style={{ 
                                     fontFamily: 'Roboto, sans-serif',
                                     fontSize: isRunning ? 'min(30vw, 35vh)' : 'min(50vw, 40vh)'
                                 }}>
                                {isOvertime ? '+' : ''}{displayMinutes.toString().padStart(2, '0')}:
                                {displaySeconds.toString().padStart(2, '0')}
                            </div>
                            
                            {/* ステータス表示 */}
                            <div className={`flex items-center justify-center gap-2 ${isRunning ? 'text-base' : 'text-lg'} text-gray-600`}>
                                {isPaused && <span className="inline-block w-2 h-2 bg-yellow-500 rounded-full"></span>}
                                {isRunning && !isPaused && <span className="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>}
                                <span>
                                    {isPaused ? '一時停止中' : isRunning ? (isOvertime ? '時間超過' : '進行中') : '待機中'}
                                </span>
                            </div>
                        </div>

                        {/* プログレスバー - 再生時は下部に配置 */}
                        <div className={`w-full max-w-4xl mx-auto ${isRunning ? 'mb-4' : 'mb-6'} relative`} style={{ zIndex: 10 }}>
                            {/* ホバー表示用の上部スペース確保 */}
                            <div className="h-24 relative">
                                <div className="absolute bottom-0 left-0 right-0 h-16 bg-gray-200 rounded-xl overflow-visible">
                                    <div 
                                        className="h-full transition-all duration-300 ease-out rounded-xl relative"
                                        style={{ 
                                            width: `${Math.min(100, progressPercentage)}%`,
                                            background: (() => {
                                                if (isOvertime) {
                                                    return 'linear-gradient(90deg, #FF7669 0%, #FFAAB3 100%)';
                                                }
                                                
                                                // 進行率に応じて段階的に色相を変化
                                                const progress = progressPercentage / 100;
                                                
                                                if (progress <= 0.7) {
                                                    // 0-70%: 純粋な青系（安全ゾーン）
                                                    return 'linear-gradient(90deg, #096FCA 0%, #76B7ED 100%)';
                                                } else if (progress <= 0.9) {
                                                    // 70-90%: 青からピンクへの美しい移行（注意ゾーン）
                                                    const transition = (progress - 0.7) / 0.2; // 0-1の値
                                                    const blueOpacity = 1 - transition * 0.6; // 青を徐々に薄く
                                                    const pinkOpacity = transition * 0.4; // ピンクを徐々に強く
                                                    
                                                    return `linear-gradient(90deg, 
                                                        rgba(9, 111, 202, ${blueOpacity}) 0%, 
                                                        rgba(255, 118, 105, ${pinkOpacity}) 100%)`;
                                                } else {
                                                    // 90-100%: ピンク優勢（警告ゾーン）
                                                    const urgency = (progress - 0.9) / 0.1; // 0-1の値
                                                    const blueOpacity = 0.4 - urgency * 0.3; // 青をさらに減らす
                                                    const pinkOpacity = 0.6 + urgency * 0.4; // ピンクをより強く
                                                    
                                                    return `linear-gradient(90deg, 
                                                        rgba(9, 111, 202, ${blueOpacity}) 0%, 
                                                        rgba(255, 118, 105, ${pinkOpacity}) 100%)`;
                                                }
                                            })()
                                        }}
                                    />
                                    {/* オーバータイム表示 */}
                                    {isOvertime && (
                                        <div 
                                            className="absolute top-0 left-0 h-full bg-gradient-to-r from-[#FF7669] to-[#FFAAB3] animate-pulse rounded-xl"
                                            style={{ width: '100%' }}
                                        />
                                    )}
                                    {/* ベル位置マーカー */}
                                    {bellSettings.filter(bell => bell.enabled).map(bell => {
                                        const timeLimit = limitTime * 60; // 常に通常の制限時間
                                        const timeValue = bell.minutes * 60; // 常に分を秒に変換
                                        
                                        const position = (timeValue / timeLimit) * 100;
                                        
                                        // ベルの回数を取得
                                        let bellCount = bell.ringCount || 1;
                                        
                                        return position <= 100 ? (
                                            <div 
                                                key={bell.id}
                                                className={`absolute top-0 h-full ${bell.isFixed ? 'w-3 bg-amber-500 rounded-r-md' : 'w-1.5 bg-white'} opacity-90 shadow-lg flex items-center justify-center group cursor-pointer`}
                                                style={{ 
                                                    left: bell.isFixed ? `calc(${position}% - 12px)` : `${position}%`, 
                                                    zIndex: 20 
                                                }}
                                                title={`${bell.isFixed ? '終了ベル' : `ベル${bellCount}`} (${bellCount}回): ${bell.minutes}分`}
                                            >
                                                {/* ベルアイコンとカウント表示 - 上部スペースに表示 */}
                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-4 flex flex-col items-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none" style={{ zIndex: 100 }}>
                                                    {/* ベルアイコンを回数分表示 */}
                                                    <div className="flex items-center gap-0.5 mb-2">
                                                        {[...Array(bellCount)].map((_, i) => (
                                                            <div key={i} className={`${bell.isFixed ? 'bg-amber-500' : 'bg-blue-600'} text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg border-2 border-white`}>
                                                                <BellIcon size={12} className="text-white" />
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {/* 時間表示 */}
                                                    <div className={`${bell.isFixed ? 'bg-amber-500' : 'bg-blue-600'} text-white px-3 py-1.5 rounded-xl text-sm font-medium shadow-lg whitespace-nowrap border-2 border-white`}>
                                                        {bell.isFixed ? '終了ベル' : `${bell.minutes}分ベル`}
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })}
                                </div>
                            </div>
                            <div className="flex justify-between text-sm text-gray-500 mt-3">
                                <span>0:00</span>
                                <span>{limitTime}:00</span>
                                {isOvertime && (
                                    <span className="text-red-500 font-medium">
                                        +{Math.floor((passedTime - actualLimitTime) / 60)}:{((passedTime - actualLimitTime) % 60).toString().padStart(2, '0')}
                                    </span>
                                )}
                            </div>
                            
                            {/* ベル設定の説明 */}
                            {!isRunning && bellSettings.filter(bell => bell.enabled).length > 0 && (
                                <div className="mt-3 flex flex-wrap items-center justify-center gap-3 text-xs text-gray-600">
                                    <span className="font-medium">ベル設定:</span>
                                    {bellSettings.filter(bell => bell.enabled).map((bell, index) => {
                                        const bellCount = bell.ringCount || 1;
                                        
                                        return (
                                            <div key={bell.id} className="flex items-center gap-1">
                                                <div className={`w-3 h-3 ${bell.isFixed ? 'bg-amber-500' : 'bg-blue-600'} rounded-full`}></div>
                                                <span>
                                                    {bell.isFixed 
                                                        ? `終了ベル (${bellCount}回)` 
                                                        : `${bell.minutes}分ベル (${bellCount}回)`
                                                    }
                                                </span>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {/* コントロールボタン - 再生時は非表示 */}
                        {!isRunning && (
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={startTimer}
                                    className="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl transition-colors flex items-center gap-2 text-lg"
                                    title="スペースキーでも開始できます"
                                >
                                    <PlayIcon size={20} className="text-white" />
                                    開始
                                </button>
                                
                                <button
                                    onClick={handleResetClick}
                                    className="px-4 py-4 bg-gray-100 hover:bg-gray-200 text-gray-600 font-medium rounded-xl transition-colors flex items-center gap-2 text-sm"
                                    title="Rキーでもリセットできます"
                                >
                                    <RotateCcwIcon size={16} className="text-gray-600" />
                                    リセット
                                </button>

                                <div className="relative">
                                    <button
                                        onClick={() => playBell(1)}
                                        onMouseEnter={handleVolumeSliderShow}
                                        onMouseLeave={handleVolumeSliderHide}
                                        className="px-6 py-4 bg-pink-100 hover:bg-pink-200 text-pink-800 font-medium rounded-xl transition-colors flex items-center gap-2"
                                        title="Bキーでも手動ベルを鳴らせます"
                                    >
                                        <BellIcon size={20} className="text-pink-800" />
                                        手動ベル
                                    </button>
                                    
                                    {/* 音量スライダー */}
                                    {showVolumeSlider && (
                                        <div 
                                            className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-3 bg-white rounded-lg shadow-lg border border-gray-200 p-3 z-50"
                                            onMouseEnter={handleVolumeSliderShow}
                                            onMouseLeave={handleVolumeSliderHide}
                                        >
                                            {/* 接続部分の見えない領域 */}
                                            <div className="absolute top-full left-0 right-0 h-4" />
                                            
                                            <div className="flex items-center gap-2 mb-1">
                                                <Volume2Icon size={16} className="text-gray-600" />
                                                <span className="text-sm font-medium text-gray-700">音量</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="1"
                                                    step="0.1"
                                                    value={bellVolume}
                                                    onChange={(e) => setBellVolume(parseFloat(e.target.value))}
                                                    className="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                />
                                                <span className="text-sm text-gray-600 w-10 text-right">
                                                    {Math.round(bellVolume * 100)}%
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 再生中の操作ボタン - プログレスバーの下に配置 */}
                        {isRunning && (
                            <div className="flex items-center justify-center gap-4 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-2xl shadow-lg border border-gray-200 mx-auto relative z-20">
                                {isPaused ? (
                                    <button
                                        onClick={startTimer}
                                        className="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-xl transition-colors flex items-center gap-2"
                                        title="スペースキーでも再開できます"
                                    >
                                        <PlayIcon size={18} className="text-white" />
                                        再開
                                    </button>
                                ) : (
                                    <button
                                        onClick={pauseTimer}
                                        className="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-xl transition-colors flex items-center gap-2"
                                        title="スペースキーでも一時停止できます"
                                    >
                                        <PauseIcon size={18} className="text-white" />
                                        一時停止
                                    </button>
                                )}
                                
                                <button
                                    onClick={handleResetClick}
                                    className="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 font-medium rounded-xl transition-colors flex items-center gap-2 text-sm"
                                    title="Rキーでもリセットできます"
                                >
                                    <RotateCcwIcon size={16} className="text-gray-600" />
                                    リセット
                                </button>

                                <div className="relative">
                                    <button
                                        onClick={() => playBell(1)}
                                        onMouseEnter={handleVolumeSliderShow}
                                        onMouseLeave={handleVolumeSliderHide}
                                        className="px-4 py-3 bg-pink-100 hover:bg-pink-200 text-pink-800 font-medium rounded-xl transition-colors flex items-center gap-2"
                                        title="Bキーでも手動ベルを鳴らせます"
                                    >
                                        <BellIcon size={18} className="text-pink-800" />
                                        ベル
                                    </button>
                                    
                                    {/* 音量スライダー */}
                                    {showVolumeSlider && (
                                        <div 
                                            className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-3 bg-white rounded-lg shadow-lg border border-gray-200 p-3 z-50"
                                            onMouseEnter={handleVolumeSliderShow}
                                            onMouseLeave={handleVolumeSliderHide}
                                        >
                                            {/* 接続部分の見えない領域 */}
                                            <div className="absolute top-full left-0 right-0 h-4" />
                                            
                                            <div className="flex items-center gap-2 mb-1">
                                                <Volume2Icon size={16} className="text-gray-600" />
                                                <span className="text-sm font-medium text-gray-700">音量</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="1"
                                                    step="0.1"
                                                    value={bellVolume}
                                                    onChange={(e) => setBellVolume(parseFloat(e.target.value))}
                                                    className="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                />
                                                <span className="text-sm text-gray-600 w-10 text-right">
                                                    {Math.round(bellVolume * 100)}%
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* リセット確認ポップアップ */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                                <div className="text-center mb-6">
                                    <div className="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#f97316" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                    </div>
                                    <h3 className="text-lg font-semibold text-gray-900 mb-2">タイマーをリセットしますか？</h3>
                                    <p className="text-sm text-gray-600">
                                        現在の進行状況がすべて失われます。この操作は取り消せません。
                                    </p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowResetConfirm(false)}
                                        className="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors"
                                    >
                                        キャンセル
                                    </button>
                                    <button
                                        onClick={resetTimer}
                                        className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors"
                                    >
                                        リセット
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 設定パネル */}
                    {showSettings && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-end p-4 overflow-y-auto"
                            onClick={() => setShowSettings(false)}
                            role="dialog"
                            aria-modal="true"
                            aria-labelledby="settings-title"
                        >
                            <div 
                                className="bg-white shadow-2xl rounded-xl w-full max-w-md my-auto"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
                                    <h2 id="settings-title" className="text-lg font-medium">設定</h2>
                                    <button
                                        onClick={() => setShowSettings(false)}
                                        className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                                        aria-label="設定を閉じる"
                                        title="Escキーでも閉じられます"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div className="p-6 space-y-6 overflow-y-auto" style={{ maxHeight: 'calc(100vh - 200px)' }}>
                                    {/* 発表時間設定 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-3">発表時間</label>
                                        <div className="flex items-center gap-3">
                                            <button
                                                onClick={() => adjustTime(-1)}
                                                disabled={limitTime <= 1 || isRunning}
                                                className="w-10 h-10 rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
                                                aria-label="時間を減らす"
                                            >
                                                −
                                            </button>
                                            <div className="flex-1 text-center py-3 px-4 bg-gray-50 rounded-lg border-2 border-transparent focus-within:border-blue-500">
                                                <span className="text-3xl font-medium">{limitTime}</span>
                                                <span className="text-sm text-gray-600 ml-1">分</span>
                                            </div>
                                            <button
                                                onClick={() => adjustTime(1)}
                                                disabled={isRunning}
                                                className="w-10 h-10 rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
                                                aria-label="時間を増やす"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>

                                    {/* 音量設定 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-3">ベル音量</label>
                                        <div className="flex items-center gap-3">
                                            <Volume2Icon size={20} className="text-gray-600" />
                                            <input
                                                type="range"
                                                min="0"
                                                max="1"
                                                step="0.1"
                                                value={bellVolume}
                                                onChange={(e) => setBellVolume(parseFloat(e.target.value))}
                                                className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                            />
                                            <span className="text-sm text-gray-600 w-12 text-right font-medium">
                                                {Math.round(bellVolume * 100)}%
                                            </span>
                                        </div>
                                        <div className="mt-2 flex justify-end">
                                            <button
                                                onClick={() => playBell(1)}
                                                className="px-3 py-1.5 bg-pink-100 hover:bg-pink-200 text-pink-800 rounded-lg transition-colors text-sm flex items-center gap-1"
                                            >
                                                <BellIcon size={14} className="text-pink-800" />
                                                テスト再生
                                            </button>
                                        </div>
                                    </div>

                                    {/* ベル設定 */}
                                    <div>
                                        <div className="flex items-center justify-between mb-3">
                                            <label className="text-sm font-medium text-gray-700">
                                                ベル設定
                                                <span className="text-xs text-gray-500 ml-2">
                                                    ({bellSettings.filter(b => !b.isFixed).length}/{limitTime - 1})
                                                </span>
                                            </label>
                                            <button
                                                onClick={addBellSetting}
                                                disabled={(() => {
                                                    const normalBells = bellSettings.filter(b => !b.isFixed);
                                                    const lastBell = normalBells[normalBells.length - 1];
                                                    const lastBellMinutes = lastBell ? lastBell.minutes : 0;
                                                    return isRunning || normalBells.length >= limitTime - 1 || lastBellMinutes >= limitTime - 1;
                                                })()}
                                                className="p-2 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                aria-label="ベルを追加"
                                                title={(() => {
                                                    const normalBells = bellSettings.filter(b => !b.isFixed);
                                                    const lastBell = normalBells[normalBells.length - 1];
                                                    const lastBellMinutes = lastBell ? lastBell.minutes : 0;
                                                    
                                                    if (normalBells.length >= limitTime - 1) {
                                                        return `最大${limitTime - 1}個まで追加可能です`;
                                                    } else if (lastBellMinutes >= limitTime - 1) {
                                                        return '最後のベルが最大時間に達しているため追加できません';
                                                    }
                                                    return 'ベルを追加';
                                                })()}
                                            >
                                                <PlusIcon size={16} className="text-blue-600" />
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {bellSettings.sort((a, b) => {
                                                // 固定ベルは最後に表示
                                                if (a.isFixed && !b.isFixed) return 1;
                                                if (!a.isFixed && b.isFixed) return -1;
                                                // 通常ベルは分数順
                                                return a.minutes - b.minutes;
                                            }).map((bell, index) => {
                                                // 現在のベルが何回目かを計算
                                                const enabledNormalBells = bellSettings.filter(b => !b.isFixed && b.enabled).sort((a, b) => a.minutes - b.minutes);
                                                let bellOrder = 1;
                                                
                                                if (bell.isFixed) {
                                                    // 終了ベル
                                                    bellOrder = enabledNormalBells.length + 1;
                                                } else {
                                                    // 通常ベル: 有効な通常ベルでの順番
                                                    const bellIndex = enabledNormalBells.findIndex(b => b.id === bell.id);
                                                    bellOrder = bellIndex + 1;
                                                }
                                                
                                                const bellCount = bell.ringCount || 1;
                                                
                                                return (
                                                    <div 
                                                        key={bell.id} 
                                                        className={`p-4 rounded-lg border-2 transition-all ${
                                                            bell.isFixed 
                                                                ? 'bg-amber-50 border-amber-200' 
                                                                : 'bg-gray-50 border-gray-200'
                                                        }`}
                                                    >
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="flex items-center gap-2">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={bell.enabled}
                                                                    onChange={(e) => updateBellSetting(bell.id, 'enabled', e.target.checked)}
                                                                    disabled={isRunning || bell.isFixed}
                                                                    className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                                                                />
                                                                <span className="text-sm font-medium text-gray-700">
                                                                    {bell.isFixed ? '終了ベル' : `${bellOrder}番目ベル`}
                                                                </span>
                                                            </div>
                                                            {!bell.isFixed && (
                                                                <button
                                                                    onClick={() => removeBellSetting(bell.id)}
                                                                    disabled={isRunning}
                                                                    className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors disabled:opacity-50"
                                                                    aria-label="ベルを削除"
                                                                >
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                                                    </svg>
                                                                </button>
                                                            )}
                                                        </div>
                                                        
                                                        {!bell.isFixed && (
                                                            <div className="space-y-3">
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            const currentValue = bell.minutes;
                                                                            const sortedNormalBells = bellSettings.filter(b => !b.isFixed).sort((a, b) => a.minutes - b.minutes);
                                                                            const currentIndex = sortedNormalBells.findIndex(b => b.id === bell.id);
                                                                            const prevBell = currentIndex > 0 ? sortedNormalBells[currentIndex - 1] : null;
                                                                            const minValue = prevBell ? prevBell.minutes + 1 : 1;
                                                                            
                                                                            const newValue = Math.max(minValue, currentValue - 1);
                                                                            updateBellSetting(bell.id, 'minutes', newValue);
                                                                        }}
                                                                        disabled={(() => {
                                                                            const sortedNormalBells = bellSettings.filter(b => !b.isFixed).sort((a, b) => a.minutes - b.minutes);
                                                                            const currentIndex = sortedNormalBells.findIndex(b => b.id === bell.id);
                                                                            const prevBell = currentIndex > 0 ? sortedNormalBells[currentIndex - 1] : null;
                                                                            const minValue = prevBell ? prevBell.minutes + 1 : 1;
                                                                            return isRunning || bell.minutes <= minValue;
                                                                        })()}
                                                                        className="w-8 h-8 rounded-lg bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-sm transition-colors"
                                                                    >
                                                                        −
                                                                    </button>
                                                                    <div className="flex-1 text-center py-2 px-3 bg-white rounded border">
                                                                        <span className="font-medium text-lg">{bell.minutes}</span>
                                                                        <span className="text-gray-600 text-sm ml-1">分</span>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => {
                                                                            const currentValue = bell.minutes;
                                                                            const sortedNormalBells = bellSettings.filter(b => !b.isFixed).sort((a, b) => a.minutes - b.minutes);
                                                                            const currentIndex = sortedNormalBells.findIndex(b => b.id === bell.id);
                                                                            const nextBell = currentIndex < sortedNormalBells.length - 1 ? sortedNormalBells[currentIndex + 1] : null;
                                                                            const maxValue = nextBell ? nextBell.minutes - 1 : limitTime - 1;
                                                                            
                                                                            const newValue = Math.min(maxValue, currentValue + 1);
                                                                            updateBellSetting(bell.id, 'minutes', newValue);
                                                                            
                                                                            if (newValue >= maxValue && nextBell) {
                                                                                let adjustTime = newValue + 1;
                                                                                for (let i = currentIndex + 1; i < sortedNormalBells.length; i++) {
                                                                                    const bellToAdjust = sortedNormalBells[i];
                                                                                    if (bellToAdjust.minutes <= adjustTime) {
                                                                                        updateBellSetting(bellToAdjust.id, 'minutes', Math.min(adjustTime, limitTime - 1));
                                                                                        adjustTime++;
                                                                                    }
                                                                                }
                                                                            }
                                                                        }}
                                                                        disabled={isRunning || bell.minutes >= limitTime - 1}
                                                                        className="w-8 h-8 rounded-lg bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-sm transition-colors"
                                                                    >
                                                                        +
                                                                    </button>
                                                                    <button
                                                                        onClick={() => playBell(bell.id)}
                                                                        className="px-3 py-2 bg-pink-100 hover:bg-pink-200 text-pink-800 rounded-lg transition-colors text-sm"
                                                                    >
                                                                        <BellIcon size={14} className="text-pink-800" />
                                                                    </button>
                                                                </div>
                                                                
                                                                {/* 回数設定 */}
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-sm text-gray-600">ベル回数:</span>
                                                                    <div className="flex items-center gap-1">
                                                                        {[1, 2, 3].map(count => (
                                                                            <button
                                                                                key={count}
                                                                                onClick={() => updateBellSetting(bell.id, 'ringCount', count)}
                                                                                disabled={isRunning}
                                                                                className={`w-8 h-8 rounded-lg font-medium text-sm transition-colors ${
                                                                                    bellCount === count
                                                                                        ? 'bg-blue-600 text-white'
                                                                                        : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                                                                                } disabled:opacity-50`}
                                                                            >
                                                                                {count}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                    <span className="text-xs text-gray-500">回</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {bell.isFixed && (
                                                            <div>
                                                                <div className="flex items-center justify-between mb-3">
                                                                    <div className="text-sm text-amber-700">
                                                                        自動設定: {limitTime}分
                                                                    </div>
                                                                    <button
                                                                        onClick={() => playBell(bell.ringCount, true)}
                                                                        className="px-3 py-2 bg-pink-100 hover:bg-pink-200 text-pink-800 rounded-lg transition-colors text-sm"
                                                                    >
                                                                        <BellIcon size={14} className="text-pink-800" />
                                                                    </button>
                                                                </div>
                                                                
                                                                {/* 終了ベルの回数設定 */}
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-sm text-gray-600">ベル回数:</span>
                                                                    <div className="flex items-center gap-1">
                                                                        {[1, 2, 3].map(count => (
                                                                            <button
                                                                                key={count}
                                                                                onClick={() => updateBellSetting(bell.id, 'ringCount', count)}
                                                                                disabled={isRunning}
                                                                                className={`w-8 h-8 rounded-lg font-medium text-sm transition-colors ${
                                                                                    bellCount === count
                                                                                        ? 'bg-amber-600 text-white'
                                                                                        : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                                                                                } disabled:opacity-50`}
                                                                            >
                                                                                {count}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                    <span className="text-xs text-gray-500">回</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* 使用方法 */}
                                    <div>
                                        <h3 className="text-sm font-medium text-gray-700 mb-3">使用方法</h3>
                                        <div className="space-y-2 text-xs text-gray-600">
                                            <p>1. 発表時間を設定します</p>
                                            <p>2. 必要に応じてベル音のタイミングを調整します</p>
                                            <p>3. 「開始」ボタンまたはスペースキーでタイマーを開始します</p>
                                            <p>4. 設定した時間にベル音が自動で鳴ります</p>
                                            <p>5. 発表時間を超過すると赤色で表示されます</p>
                                            {isTestMode && (
                                                <p className="text-orange-600 font-medium">テストモード: 20倍速で時間が進行します</p>
                                            )}
                                            <div className="mt-3 pt-3 border-t border-gray-200">
                                                <p className="font-medium text-gray-700 mb-1">キーボードショートカット:</p>
                                                <p>• スペースキー: 開始/一時停止/再開</p>
                                                <p>• Rキー: リセット</p>
                                                <p>• Bキー: 手動ベル</p>
                                                <p>• Escキー: 設定を閉じる</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // アプリケーションをレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PresentationTimer />);
    </script>
</body>
</html>
